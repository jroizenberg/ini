<project name="FM" default="build.multiple" basedir=".">
	<tstamp />
	<!-- loading properties file -->
	<property file="build.properties" />
	<property name="distr" location="distr" />
	<property name="builds" location="builds" />
	<property name="external.dir" location="../external" />
	<property name="external.libDir" location="${external.dir}/lib" />
	<property name="external.zkTheme.buildDir" location="${external.dir}/zk-theme/build" />
	<property name="fm.com.jarName" location="${distr}/fm-com.jar" />
	<property name="fm.com.binDir" location="../fm-com/bin" />
	<property name="fm.obj.jarName" location="${distr}/fm-obj.jar" />
	<property name="fm.obj.binDir" location="../fm-obj/bin" />
	<property name="fm.import.binDir" location="../fm-import/bin" />
	<property name="fm.bzi.jarName" location="${distr}/fm-bzi.jar" />
	<property name="fm.bzi.binDir" location="../fm-bzi/build/classes" />
	<property name="fm.bz.jarName" location="${distr}/fm-bz.jar" />
	<property name="fm.bz.binDir" location="../fm-bz/build/classes" />
	<property name="fm.web.warName" location="${distr}/fm-web.war" />
	<property name="fm.web.binDir" location="../fm-web/build/classes" />
	<property name="fm.web.wcDir" location="../fm-web/WebContent" />
	<property name="fm.ws.web.warName" location="${distr}/fm-ws-web.war" />
	<property name="fm.ws.web.binDir" location="../fm-ws-web/build/classes" />
	<property name="fm.ws.web.wcDir" location="../fm-ws-web/WebContent" />
	<property name="fm.earName" location="${distr}/fm.ear" />
	<property name="fm.appFileName" location="../external/fm-cal/application.xml" />
	<property name="distr.fm.cal" location="../external/fm-cal" />
	<property name="fm.ws.earName" location="${distr}/fm-ws.ear" />
	<property name="fm.ws.appFileName" location="../fm-ws/EarContent/META-INF/application.xml" />
	<property name="fm.deploy.fileName" location="${distr}/fm-contrib.zip" />
	<property name="fm.zktheme.jar" location="${external.zkTheme.buildDir}/fm-zktheme.jar" />
	<property name="fm.zktheme.dir" location="${external.dir}/zk-theme/fm" />
	<property name="fm.web.isolation" location="../external/isolation/Web/jboss-web.xml" />

	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
	  <classpath>
	    <pathelement location="${external.libDir}/ant-contrib-1.0b2.jar"/>
	  </classpath>
	</taskdef>

	<target name="build.structure">
		<!-- Create the distribution directory -->
		<mkdir dir="${distr}" />
	</target>

	<!-- all -->
	<target name="build" depends="build.fm, build.fm.ws, deploy, builds" />
	
	<!-- all multiple -->
	<target name="build.multiple" depends="build.fm.multiple, build.fm.ws, deploy, builds" />


	<target name="build.fm" depends="build.structure, build.fm.com, build.fm.obj, build.fm.bzi, build.fm.bz, build.fm.web">
		<!-- Creates fm.ear -->
		<ear destfile="${fm.earName}" appxml="${fm.appFileName}">
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
			</manifest>
			<zipfileset dir="${external.libDir}" includes="${ear.lib.packaging}" />
			<zipfileset dir="${distr}" includes="${ear.module.packaging}" />
			<zipfileset dir="${distr.fm.cal}" includes="${ear.module2.packaging}" />
			<metainf dir="${external.dir}/isolation" includes="*.xml"/>
		</ear>
	</target>
	
	<!-- Removes the distribution files -->
	<target name="clean" >
		<delete dir="${distr}"/>
		<delete>
			<fileset dir="${builds}">
			    <include name="fm*.*"/>
			</fileset>
		</delete>
	</target>

	<!-- Creates fm-com.jar -->
	<target name="build.fm.com" depends="build.structure">
		<copy file="fm.properties" todir="${distr}">
			<filterchain>
				<filterreader classname="org.apache.tools.ant.filters.ExpandProperties" />
			</filterchain>
		</copy>
		<jar jarfile="${fm.com.jarName}" basedir="${fm.com.binDir}" includes="com/asofarma/fm/**">
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
			</manifest>
			<zipfileset prefix="com/asofarma/fm/conf" dir="${distr}" includes="fm.properties" />
		</jar>
		<move file="${distr}/fm.properties" todir="../fm-com/src/com/asofarma/fm/conf" />
	</target>

	<!-- Creates fm-obj.jar -->
	<target name="build.fm.obj" depends="build.structure">
		<jar jarfile="${fm.obj.jarName}" basedir="${fm.obj.binDir}" includes="com/asofarma/fm/**">
			<fileset dir="${fm.obj.binDir}" casesensitive="false" includes="*.xml" />
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
			</manifest>
		</jar>
	</target>

	<!-- Creates fm-bzi.jar -->
	<target name="build.fm.bzi" depends="build.structure">
		<jar jarfile="${fm.bzi.jarName}" basedir="${fm.bzi.binDir}" includes="com/asofarma/fm/**">
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
			</manifest>
			<metainf dir="${fm.bzi.binDir}/META-INF" includes="*.xml"/>
		</jar>
	</target>

	<!-- Creates fm-bz.jar -->
	<target name="build.fm.bz" depends="build.structure">
		<jar jarfile="${fm.bz.jarName}" basedir="${fm.bz.binDir}" includes="com/asofarma/fm/**">
			<fileset dir="${fm.bz.binDir}" includes="*.xml" />
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
				<attribute name="Class-Path" value="${fm.bz.class.path}" />
			</manifest>
			<metainf dir="${fm.bz.binDir}/META-INF" includes="*.xml"/>
		</jar>
	</target>

	<target name="build.fm.web" depends="build.structure">
		<war destfile="${fm.web.warName}" webxml="${fm.web.wcDir}/WEB-INF/web.xml">
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
				<attribute name="Class-Path" value="${fm.web.class.path}" />
			</manifest>
			<classes dir="${fm.web.binDir}" includes="com/asofarma/fm/**" />
			<lib dir="${external.libDir}" includes="${web.lib.packaging}" />
			<lib file="${fm.zktheme.jar}" />
			<zipfileset prefix="WEB-INF" dir="${fm.web.wcDir}/WEB-INF" casesensitive="false" includes="*.xml" />
			<zipfileset prefix="WEB-INF" dir="${fm.web.wcDir}/WEB-INF" includes="*.properties" />
			<webinf dir="${external.dir}/isolation/Web" includes="jboss-web.xml"/>
			<zipfileset dir="${fm.web.wcDir}" includes="*/**" >
				<exclude name="META-INF/*"/>
				<exclude name="WEB-INF/*"/>
			</zipfileset>
		</war>
	</target>

	<target name="build.fm.ws" depends="build.structure, build.fm, build.fm.ws.web">
		<!-- Creates fm-ws.ear -->
		<ear destfile="${fm.ws.earName}" appxml="${fm.ws.appFileName}" >
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
			</manifest>
			<zipfileset dir="${distr}" includes="${ws.ear.module.packaging}" />
			<metainf dir="${external.dir}/isolation/WS" includes="*.xml"/>
		</ear>
	</target>
	
	<!-- Creates fm-ws-web.war -->
	<target name="build.fm.ws.web" depends="build.structure">
		<war destfile="${fm.ws.web.warName}" webxml="${fm.ws.web.wcDir}/WEB-INF/web.xml">
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
			</manifest>
			<classes dir="${fm.ws.web.binDir}" includes="com/asofarma/fm/**" />
			<lib dir="${external.libDir}" includes="${ws.web.lib.packaging}" />
			<lib dir="${distr}" includes="${ws.web.lib2.packaging}" />
			<zipfileset prefix="WEB-INF" dir="${fm.ws.web.wcDir}/WEB-INF" casesensitive="false" includes="*.xml" />
			<zipfileset prefix="WEB-INF" dir="${fm.ws.web.wcDir}/WEB-INF" includes="*.properties" />
			<zipfileset dir="${fm.ws.web.wcDir}" includes="*/**" >
				<exclude name="META-INF/*"/>
				<exclude name="WEB-INF/*"/>
			</zipfileset>
		</war>
	</target>

	<target name="deploy" depends="build.fm">
		<!-- makes deployment contribution files -->
		<zip destfile="${fm.deploy.fileName}" update="true">
			<zipfileset prefix="lib" dir="${external.libDir}/jboss" casesensitive="false" includes="${fm.deployment.lib}" />
			<zipfileset prefix="lib/birt" dir="${external.libDir}/birt" casesensitive="false" includes="*.*" />
			<zipfileset prefix="xml" dir="${external.dir}" casesensitive="false" includes="*.xml" />
			<zipfileset prefix="properties" dir="${external.dir}" casesensitive="false" includes="*.properties" />
			<zipfileset prefix="sql" dir="${external.dir}/../../Queries" casesensitive="false" includes="*.SQL" />
			<zipfileset prefix="sql" dir="${external.dir}/../../Queries/StartUp" casesensitive="false" includes="*.SQL" />
			<zipfileset prefix="sql" dir="${external.dir}/../../Queries/Alters" casesensitive="false" includes="*.SQL" />
			<zipfileset prefix="sql" dir="${external.dir}/../../Queries/Alters-2011-2" casesensitive="false" includes="*.SQL" />
			<zipfileset prefix="import" dir="${fm.import.binDir}" casesensitive="false" includes="**/*.class" />
			<zipfileset prefix="import" dir="${external.dir}/import-files" casesensitive="false" includes="*.csv" />
			<zipfileset prefix="import" dir="${external.dir}/import-files" casesensitive="false" includes="*.bat" />
			<zipfileset prefix="import" dir="${external.dir}/import-files" casesensitive="false" includes="*.sh" />
			<zipfileset prefix="import" dir="${external.libDir}/jboss" casesensitive="false" includes="postgresql-8.3-603.jdbc4.jar" />
			<zipfileset prefix="import" dir="${distr}" casesensitive="false" includes="fm-obj.jar" />
		</zip>
</target>
	
	<target name="zk-theme">
		<delete file="${fm.zktheme.jar}"/>
		<zip destfile="${fm.zktheme.jar}" basedir="${fm.zktheme.dir}" />
		<echo message="Se debe hacer refresh sobre el proyecto EXTERNAL del workspace" />
	</target>
	
	<target name="builds" depends="build.fm, build.fm.ws, deploy">
		<copy file="${fm.earName}" todir="${builds}" />
		<copy file="${fm.deploy.fileName}" todir="${builds}" />
		<copy file="${fm.ws.earName}" todir="${builds}" />
		<move todir="${builds}">
			<fileset dir="${distr}">
			    <include name="fm-as*.ear*"/>
			</fileset>
		</move>
	</target>
	
	<!-- Creates fm-fm-MULTIPLE.ear -->
	<target name="build.fm.multiple" depends="build.fm, build.fm.web.multiple">
		<!-- asofarma002 -->
		<!--<copy file="${fm.earName}"  tofile="${distr}/fm-asofarma002.ear" overwrite="true" />
		<ear destfile="${distr}/fm-asofarma002.ear" update="true" >
			<zipfileset dir="${distr}" includes="fm-web-002.war" fullpath="fm-web.war"/>
		</ear>-->	
	
		<!-- asofarma003 -->
	<!--	<copy file="${fm.earName}"  tofile="${distr}/fm-asofarma003.ear" overwrite="true" />
		<ear destfile="${distr}/fm-asofarma003.ear" update="true" >
			<zipfileset dir="${distr}" includes="fm-web-003.war" fullpath="fm-web.war"/>
		</ear>-->
		
		<!-- asofarma003-E2 -->
		<!--<copy file="${fm.earName}"  tofile="${distr}/fm-asofarma003-E2.ear" overwrite="true" />
		<ear destfile="${distr}/fm-asofarma003-E2.ear" update="true" >
			<zipfileset dir="${distr}" includes="fm-web-003-E2.war" fullpath="fm-web.war"/>
		</ear>-->
		
		<!-- asofarma003-USA-UY -->
		<!--<copy file="${fm.earName}"  tofile="${distr}/fm-asofarma003-USA-UY.ear" overwrite="true" />
		<ear destfile="${distr}/fm-asofarma003-USA-UY.ear" update="true" >
			<zipfileset dir="${distr}" includes="fm-web-003-USA-UY.war" fullpath="fm-web.war"/>
		</ear>-->	
			
		<!-- asofarma003-USA-CL -->
		<!--<copy file="${fm.earName}"  tofile="${distr}/fm-asofarma003-USA-CL.ear" overwrite="true" />
		<ear destfile="${distr}/fm-asofarma003-USA-CL.ear" update="true" >
			<zipfileset dir="${distr}" includes="fm-web-003-USA-CL.war" fullpath="fm-web.war"/>
		</ear>-->	
				
		<!-- asofarma003-USA-VE -->
		<!--<copy file="${fm.earName}"  tofile="${distr}/fm-asofarma003-USA-VE.ear" overwrite="true" />
		<ear destfile="${distr}/fm-asofarma003-USA-VE.ear" update="true" >
			<zipfileset dir="${distr}" includes="fm-web-003-USA-VE.war" fullpath="fm-web.war"/>
		</ear>
		-->
		<!-- asofarma004 -->
		<!--<copy file="${fm.earName}"  tofile="${distr}/fm-asofarma004.ear" overwrite="true" />
		<ear destfile="${distr}/fm-asofarma004.ear" update="true" >
			<zipfileset dir="${distr}" includes="fm-web-004.war" fullpath="fm-web.war"/>
		</ear>-->	
	
		<!-- asofarma005 -->
		<!--<copy file="${fm.earName}"  tofile="${distr}/fm-asofarma005.ear" overwrite="true" />
		<ear destfile="${distr}/fm-asofarma005.ear" update="true" >
			<zipfileset dir="${distr}" includes="fm-web-005.war" fullpath="fm-web.war"/>
		</ear>-->	
		
		<!-- asofarma007 -->
		<!--<copy file="${fm.earName}"  tofile="${distr}/fm-asofarma007.ear" overwrite="true" />
		<ear destfile="${distr}/fm-asofarma007.ear" update="true" >
			<zipfileset dir="${distr}" includes="fm-web-007.war" fullpath="fm-web.war"/>
		</ear>-->	
	
		<!-- delete the temporal wars -->
		<delete>
			<fileset dir="${distr}">
			    <include name="fm-web-*.war*"/>
			</fileset>
		</delete>
	
	</target>
		
	<!-- Creates fm-web-MULTIPLE.war -->
	<target name="build.fm.web.multiple" depends="build.fm.web">
		<!-- asofarma002 -->
	<!--	<copy file="${fm.web.warName}"  tofile="${distr}/fm-web-002.war" overwrite="true" />
		<var name="fmcal.http.url" value="http://asofarma002:8080" />
		<copy file="../external/fm-cal/fe-cal.zul" todir="${distr}" overwrite="true">
			<filterchain>
				<filterreader classname="org.apache.tools.ant.filters.ExpandProperties" />
			</filterchain>
		</copy>
		<war destfile="${distr}/fm-web-002.war" update="true">
			<zipfileset prefix="test" dir="${distr}" includes="*.zul" />
		</war>-->

		<!-- asofarma003-E2 -->
<!--		<copy file="${fm.web.warName}"  tofile="${distr}/fm-web-003-E2.war" overwrite="true" />
		<var name="fmcal.http.url" value="http://asofarma003-e2:8080" />
		<copy file="../external/fm-cal/fe-cal.zul" todir="${distr}" overwrite="true">
			<filterchain>
				<filterreader classname="org.apache.tools.ant.filters.ExpandProperties" />
			</filterchain>
		</copy>			
		<war destfile="${distr}/fm-web-003-E2.war" update="true">
			<zipfileset prefix="test" dir="${distr}" includes="*.zul" />
		</war>-->		

		<!-- asofarma003-USA-UY -->
		<!--<copy file="${fm.web.warName}"  tofile="${distr}/fm-web-003-USA-UY.war" overwrite="true" />
		<var name="fmcal.http.url" value="http://uy.focus-med.com" />
		<copy file="../external/fm-cal/fe-cal.zul" todir="${distr}" overwrite="true">
			<filterchain>
				<filterreader classname="org.apache.tools.ant.filters.ExpandProperties" />
			</filterchain>
		</copy>			
		<war destfile="${distr}/fm-web-003-USA-UY.war" update="true">
			<zipfileset prefix="test" dir="${distr}" includes="*.zul" />
		</war>-->	
				
		<!-- asofarma003-USA-CL -->
		<!--<copy file="${fm.web.warName}"  tofile="${distr}/fm-web-003-USA-CL.war" overwrite="true" />
		<var name="fmcal.http.url" value="http://cl.focus-med.com" />
		<copy file="../external/fm-cal/fe-cal.zul" todir="${distr}" overwrite="true">
			<filterchain>
				<filterreader classname="org.apache.tools.ant.filters.ExpandProperties" />
			</filterchain>
		</copy>			
		<war destfile="${distr}/fm-web-003-USA-CL.war" update="true">
			<zipfileset prefix="test" dir="${distr}" includes="*.zul" />
		</war>-->	
				
		<!-- asofarma003-USA-VE -->
		<!--<copy file="${fm.web.warName}"  tofile="${distr}/fm-web-003-USA-VE.war" overwrite="true" />
		<var name="fmcal.http.url" value="http://ve.focus-med.com" />
		<copy file="../external/fm-cal/fe-cal.zul" todir="${distr}" overwrite="true">
			<filterchain>
				<filterreader classname="org.apache.tools.ant.filters.ExpandProperties" />
			</filterchain>
		</copy>			
		<war destfile="${distr}/fm-web-003-USA-VE.war" update="true">
			<zipfileset prefix="test" dir="${distr}" includes="*.zul" />
		</war>-->	
		
		<!-- asofarma004 -->
		<!--<copy file="${fm.web.warName}"  tofile="${distr}/fm-web-004.war" overwrite="true" />
		<var name="fmcal.http.url" value="http://200.80.235.251:8888" />
		<copy file="../external/fm-cal/fe-cal.zul" todir="${distr}" overwrite="true">
			<filterchain>
				<filterreader classname="org.apache.tools.ant.filters.ExpandProperties" />
			</filterchain>
		</copy>			
		<war destfile="${distr}/fm-web-004.war" update="true">
			<zipfileset prefix="test" dir="${distr}" includes="*.zul" />
		</war>-->
		
		<!-- asofarma005 -->
		<!--<copy file="${fm.web.warName}"  tofile="${distr}/fm-web-005.war" overwrite="true" />
		<var name="fmcal.http.url" value="http://200.80.235.251:9999/" />
		<copy file="../external/fm-cal/fe-cal.zul" todir="${distr}" overwrite="true">
			<filterchain>
				<filterreader classname="org.apache.tools.ant.filters.ExpandProperties" />
			</filterchain>
		</copy>			
		<war destfile="${distr}/fm-web-005.war" update="true">
			<zipfileset prefix="test" dir="${distr}" includes="*.zul" />
		</war>-->
		
		<!-- asofarma007 -->
		<!--<copy file="${fm.web.warName}"  tofile="${distr}/fm-web-007.war" overwrite="true" />
		<var name="fmcal.http.url" value="http://200.80.235.251:7777/" />
		<copy file="../external/fm-cal/fe-cal.zul" todir="${distr}" overwrite="true">
			<filterchain>
				<filterreader classname="org.apache.tools.ant.filters.ExpandProperties" />
			</filterchain>
		</copy>			
		<war destfile="${distr}/fm-web-007.war" update="true">
			<zipfileset prefix="test" dir="${distr}" includes="*.zul" />
		</war>-->
	</target>
	
</project>