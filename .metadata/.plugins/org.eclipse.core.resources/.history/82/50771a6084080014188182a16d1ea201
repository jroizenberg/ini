<project name="FM" default="build.multiple" basedir=".">
	<tstamp />
	<!-- loading properties file -->
	<property file="build.properties" />
	<property name="distr" location="distr" />
	<property name="builds" location="builds" />
	<property name="external.dir" location="../external" />
	<property name="external.libDir" location="${external.dir}/lib" />
	<property name="external.zkTheme.buildDir" location="${external.dir}/zk-theme/build" />
	<property name="fm.com.jarName" location="${distr}/fm-com.jar" />
	<property name="fm.com.binDir" location="../fm-com/bin" />
	<property name="fm.obj.jarName" location="${distr}/fm-obj.jar" />
	<property name="fm.obj.binDir" location="../fm-obj/bin" />
	<property name="fm.import.binDir" location="../fm-import/bin" />
	<property name="fm.bzi.jarName" location="${distr}/fm-bzi.jar" />
	<property name="fm.bzi.binDir" location="../fm-bzi/build/classes" />
	<property name="fm.bz.jarName" location="${distr}/fm-bz.jar" />
	<property name="fm.bz.binDir" location="../fm-bz/build/classes" />
	<property name="fm.web.warName" location="${distr}/fm-web.war" />
	<property name="fm.web.binDir" location="../fm-web/build/classes" />
	<property name="fm.web.wcDir" location="../fm-web/WebContent" />
	<property name="fm.ws.web.warName" location="${distr}/fm-ws-web.war" />
	<property name="fm.ws.web.binDir" location="../fm-ws-web/build/classes" />
	<property name="fm.ws.web.wcDir" location="../fm-ws-web/WebContent" />
	<property name="fm.earName" location="${distr}/fm.ear" />
	<property name="fm.deploy.fileName" location="${distr}/fm-contrib.zip" />
	<property name="fm.zktheme.jar" location="${external.zkTheme.buildDir}/fm-zktheme.jar" />
	<property name="fm.zktheme.dir" location="${external.dir}/zk-theme/fm" />

	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
	  <classpath>
	    <pathelement location="${external.libDir}/ant-contrib-1.0b2.jar"/>
	  </classpath>
	</taskdef>

	<target name="build.structure">
		<!-- Create the distribution directory -->
		<mkdir dir="${distr}" />
	</target>

	<!-- all -->
	<target name="build" depends="build.fm, build.fm.ws, deploy, builds" />
	
	<!-- all multiple -->
	<target name="build.multiple" depends="build.fm.multiple, build.fm.ws, deploy, builds" />


	<target name="build.fm" depends="build.structure, build.fm.com, build.fm.obj, build.fm.bzi, build.fm.bz, build.fm.web">
		<!-- Creates fm.ear -->
	
	</target>
	
	<!-- Removes the distribution files -->
	<target name="clean" >
		<delete dir="${distr}"/>
		<delete>
			<fileset dir="${builds}">
			    <include name="fm*.*"/>
			</fileset>
		</delete>
	</target>

	<!-- Creates fm-com.jar -->
	<target name="build.fm.com" depends="build.structure">
		<copy file="fm.properties" todir="${distr}">
			<filterchain>
				<filterreader classname="org.apache.tools.ant.filters.ExpandProperties" />
			</filterchain>
		</copy>
		<jar jarfile="${fm.com.jarName}" basedir="${fm.com.binDir}" includes="com/asofarma/fm/**">
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
			</manifest>
			<zipfileset prefix="com/asofarma/fm/conf" dir="${distr}" includes="fm.properties" />
		</jar>
		<move file="${distr}/fm.properties" todir="../fm-com/src/com/asofarma/fm/conf" />
	</target>

	<!-- Creates fm-obj.jar -->
	<target name="build.fm.obj" depends="build.structure">
		<jar jarfile="${fm.obj.jarName}" basedir="${fm.obj.binDir}" includes="com/asofarma/fm/**">
			<fileset dir="${fm.obj.binDir}" casesensitive="false" includes="*.xml" />
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
			</manifest>
		</jar>
	</target>

	<!-- Creates fm-bzi.jar -->
	<target name="build.fm.bzi" depends="build.structure">
		<jar jarfile="${fm.bzi.jarName}" basedir="${fm.bzi.binDir}" includes="com/asofarma/fm/**">
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
			</manifest>
			<metainf dir="${fm.bzi.binDir}/META-INF" includes="*.xml"/>
		</jar>
	</target>

	<!-- Creates fm-bz.jar -->
	<target name="build.fm.bz" depends="build.structure">
		<jar jarfile="${fm.bz.jarName}" basedir="${fm.bz.binDir}" includes="com/asofarma/fm/**">
			<fileset dir="${fm.bz.binDir}" includes="*.xml" />
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
				<attribute name="Class-Path" value="${fm.bz.class.path}" />
			</manifest>
			<metainf dir="${fm.bz.binDir}/META-INF" includes="*.xml"/>
		</jar>
	</target>

	<target name="build.fm.web" depends="build.structure">
		<war destfile="${fm.web.warName}" webxml="${fm.web.wcDir}/WEB-INF/web.xml">
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
				<attribute name="Class-Path" value="${fm.web.class.path}" />
			</manifest>
			<classes dir="${fm.web.binDir}" includes="com/asofarma/fm/**" />
			<lib dir="${external.libDir}" includes="${web.lib.packaging}" />
			<lib file="${fm.zktheme.jar}" />
			<zipfileset prefix="WEB-INF" dir="${fm.web.wcDir}/WEB-INF" casesensitive="false" includes="*.xml" />
			<zipfileset prefix="WEB-INF" dir="${fm.web.wcDir}/WEB-INF" includes="*.properties" />
			<zipfileset dir="${fm.web.wcDir}" includes="*/**" >
				<exclude name="META-INF/*"/>
				<exclude name="WEB-INF/*"/>
			</zipfileset>
		</war>
	</target>

	<target name="build.fm.ws" depends="build.structure, build.fm">
	</target>
	
	<!-- Creates fm-ws-web.war -->
	<target name="build.fm.ws.web" depends="build.structure">
		<war destfile="${fm.ws.web.warName}" webxml="${fm.ws.web.wcDir}/WEB-INF/web.xml">
			<manifest>
				<attribute name="Extension-Name" value="${extension.name}" />
				<attribute name="Specification-Vendor" value="${specification.vendor}" />
				<attribute name="Specification-Version" value="${specification.version}" />
				<attribute name="Specification-Title" value="${specification.title}" />
				<attribute name="Implementation-Vendor" value="${implementation.vendor}" />
				<attribute name="Implementation-Version" value="${implementation.version}" />
			</manifest>
			<classes dir="${fm.ws.web.binDir}" includes="com/asofarma/fm/**" />
			<lib dir="${external.libDir}" includes="${ws.web.lib.packaging}" />
			<lib dir="${distr}" includes="${ws.web.lib2.packaging}" />
			<zipfileset prefix="WEB-INF" dir="${fm.ws.web.wcDir}/WEB-INF" casesensitive="false" includes="*.xml" />
			<zipfileset prefix="WEB-INF" dir="${fm.ws.web.wcDir}/WEB-INF" includes="*.properties" />
			<zipfileset dir="${fm.ws.web.wcDir}" includes="*/**" >
				<exclude name="META-INF/*"/>
				<exclude name="WEB-INF/*"/>
			</zipfileset>
		</war>
	</target>

	<target name="deploy" depends="build.fm">
		<!-- makes deployment contribution files -->
		<zip destfile="${fm.deploy.fileName}" update="true">
			<zipfileset prefix="lib" dir="${external.libDir}/jboss" casesensitive="false" includes="${fm.deployment.lib}" />
			<zipfileset prefix="xml" dir="${external.dir}" casesensitive="false" includes="*.xml" />
			<zipfileset prefix="properties" dir="${external.dir}" casesensitive="false" includes="*.properties" />
			<zipfileset prefix="import" dir="${external.libDir}/jboss" casesensitive="false" includes="postgresql-8.3-603.jdbc4.jar" />
			<zipfileset prefix="import" dir="${distr}" casesensitive="false" includes="fm-obj.jar" />
		</zip>
</target>
	
	<target name="zk-theme">
		<delete file="${fm.zktheme.jar}"/>
		<zip destfile="${fm.zktheme.jar}" basedir="${fm.zktheme.dir}" />
		<echo message="Se debe hacer refresh sobre el proyecto EXTERNAL del workspace" />
	</target>
	
	<target name="builds" depends="build.fm, build.fm.ws, deploy">
		<copy file="${fm.earName}" todir="${builds}" />
		<copy file="${fm.deploy.fileName}" todir="${builds}" />
		<move todir="${builds}">
			<fileset dir="${distr}">
			    <include name="fm-as*.ear*"/>
			</fileset>
		</move>
	</target>
	
	<!-- Creates fm-fm-MULTIPLE.ear -->
	<target name="build.fm.multiple" depends="build.fm, build.fm.web.multiple">
			<delete>
			<fileset dir="${distr}">
			    <include name="fm-web-*.war*"/>
			</fileset>
		</delete>
	
	</target>
		
	<!-- Creates fm-web-MULTIPLE.war -->
	<target name="build.fm.web.multiple" depends="build.fm.web">
	
	</target>
	
</project>